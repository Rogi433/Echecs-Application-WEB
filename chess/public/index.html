<!DOCTYPE html>

<html lang="fr">
<meta charset="utf-8">

<title>Echecs</title>

<style>

#page_accueil div{
	text-align : center;
	padding-bottom : 3vh;
}

td {
	padding : 0.25vw;
	background-repeat: no-repeat;
	background-position: center;
	background-size: 2.5vw;
}

td:hover {
	border: 0.25vw solid red;
	padding:0;
}

img{
	padding-left : 1vw;
}

#echiquier{
	border : solid black;
	margin : 0 5vw;
}

#promotion{
padding-top:1vw;
margin : 0 5vw;
width : 30vw;
text-align:center;
}

#chat{
	width : 40vw;
	text-align:center;
	border : solid black;
}

#chatContent{
	height : 22.5vw;
	overflow : auto;
	
}

#inputZone{
	padding-bottom: 1vw;
	
}

.message{
	width : 10vw;
	font-size: 1.5vw;
}
</style>


<body>



<div id="page_accueil">

<h1>Liste des parties d'échecs</h1>
<div id="liste_parties"></div>

<div><label for="nomPartie">Nom de la partie à créer :</label>
  <input type="text" id="nomPartie" name="nomPartie"> <button id="boutonCreer">Créer la partie</button> </div>

</div>




<div id="page_jeu" style="display : none;">

<h1>Jeu d'échecs</h1>
<div id="contenu">
<p>Vous etes le joueur <span id="indication_joueur"></span> 
<br/> <span id="info_tour">En pause tant qu'il n'y a pas deux joueur connectés à la partie...</span></p>
<table id="echiquier" style="float:left"></table>

<div id="chat" style="float:left">Chat :<br/><hr style="height : 0.1vw; background : black"/> <div id="chatContent"></div><br/><hr style="height : 0.1vw; background : black"/>
<div id="inputZone"><label class="message" for="messageText">Message à envoyer :</label>
  <input class="message" type="text" id="messageText" name="messageText"> <button class="message" id="boutonEnvoi">Envoyer</button> </div>
  </div>
  
 <div id="promotion" style="clear:left">Promotion :<br/><hr/></div></div>
 
 
 <div id="infoPartie" style="clear:left"></div>

</div>



<div id="deconnection" style="display : none;"><h1>Attention</h1>Vous etes déconnecté</div>



</body>

<script src="/socket.io/socket.io.js"></script>
  

<script>

var socket = io();

socket.on('disconnect',function(){
	page_accueil.style.display="none";
	page_jeu.style.display="none";
	deconnection.style.display="block";
});

socket.on('listeParties',function(noms,blancs,noirs,fins){
	liste_parties.innerHTML="";
	liste_noms=JSON.parse(noms);
	blancLibres=JSON.parse(blancs);
	noirLibres=JSON.parse(noirs);
	finies=JSON.parse(fins);
	
	for (let k=0; k<liste_noms.length; k++) addPartie(k,liste_noms[k],blancLibres[k],noirLibres[k],finies[k]); // ajout de toutes les parties deja existantes dans la liste
	
});

socket.on('updatePartie',function(id,blancLibre,noirLibre){
	let div=document.getElementById(id+"_div");
	if (div.childElementCount>1){//check if game has not ended
		let boutonBlanc=document.getElementById(id+"_blanc");
		let boutonNoir=document.getElementById(id+"noir");
	
		if (blancLibre) boutonBlanc.disabled="false";
		else boutonBlanc.disabled="true";
	
		if (noirLibre) boutonNoir.disabled="false";
		else boutonNoir.disabled="true";
	}

	
});

socket.on('endPartie',function(id){
	let div=document.getElementById(id+"_div");
	div.innerHTML="Cette partie est finie";
});

nomPartie.addEventListener("keyup", function(event) {
    event.preventDefault();
    if (event.keyCode === 13) {
        boutonCreer.click();
    }
});

boutonCreer.addEventListener('click',function(){
	let nom=nomPartie.value;
	if (nom!=""){
		nomPartie.value="";
		socket.emit('createGame',nom,addPartie);
	}
});


function join(id,joueur){

	this.disabled="true";
	
	socket.emit('joinGame',id,joueur);
	
	page_accueil.style.display="none";
	page_jeu.style.display="block";
	
	
	
}

function addPartie(id,name,blancLibre,noirLibre,finie){


	let div = document.createElement("div");
	
	if (finie){
		div.innerHTML=name+" : partie finie !";
	}
	else{
		let bouton1 = document.createElement("button");
		bouton1.textContent="Rejoindre en tant que blanc";
		bouton1.addEventListener('click', function(){join(id,1)});
		if(!blancLibre) bouton1.disabled="true";
		
		
		let bouton2 = document.createElement("button");
		bouton2.textContent="Rejoindre en tant que noir";
		bouton2.addEventListener('click', function(){join(id,-1)});
		if(!noirLibre) bouton2.disabled="true";
		
		let texte=document.createTextNode(" - "+name+" - ");
		
		div.appendChild(bouton1);
		div.appendChild(texte);
		div.appendChild(bouton2);
	}

	
	liste_parties.appendChild(div);
}


</script>

<script src="script_chess.js"></script>
